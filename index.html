<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIP Calculator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { urdu: ['Noto Naskh Arabic', 'Noto Nastaliq Urdu', 'system-ui', 'sans-serif'] },
          colors: {
            primary: '#0ea5e9', gain: '#16a34a', loss: '#dc2626',
            contrib: '#6366f1', total: '#0ea5e9', interest: '#22c55e'
          }
        }
      }
    }
  </script>
  <!-- D3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <!-- Optional Urdu font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: system-ui, sans-serif; }
    [lang="ur"] body { font-family: 'Noto Naskh Arabic', system-ui, sans-serif; }
    .number-input::-webkit-outer-spin-button,
    .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="max-w-6xl mx-auto p-4 sm:p-6">
    <div class="flex justify-end mb-3">
      <select id="langSelect" class="border border-slate-300 rounded-lg px-2 py-1 text-sm">
        <option value="en">English</option>
        <option value="ur">اردو</option>
      </select>
    </div>
    <h1 class="text-2xl sm:text-3xl font-semibold text-slate-900"></h1>
    <p class="text-slate-600 mt-1"></p>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Controls -->
    <section class="lg:col-span-1 bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6 space-y-4">
      <h2 class="text-lg font-semibold"></h2>

      <label class="block" for="amount">
        <span class="text-sm text-slate-600" data-i18n="amount"></span>
        <input id="amount" type="number" class="number-input mt-1 w-full rounded-lg border-slate-300 focus:border-primary focus:ring-primary" value="2000" min="0" step="100">
      </label>

      <div class="grid grid-cols-2 gap-3">
        <label class="block" for="rateMonthlyPct">
          <span class="text-sm text-slate-600" data-i18n="monthlyRate"></span>
          <input id="rateMonthlyPct" type="number" class="number-input mt-1 w-full rounded-lg border-slate-300 focus:border-primary focus:ring-primary" value="1.667" step="0.01" min="-100" max="100">
        </label>
        <label class="block" for="months">
          <span class="text-sm text-slate-600" data-i18n="months"></span>
          <input id="months" type="number" class="number-input mt-1 w-full rounded-lg border-slate-300 focus:border-primary focus:ring-primary" value="36" min="1" step="1">
        </label>
      </div>

      <fieldset class="space-y-2">
        <legend class="text-sm text-slate-600" data-i18n="depositTiming"></legend>
        <label class="flex items-center gap-2">
          <input type="radio" name="timing" value="begin" id="payBegin" checked>
          <span data-i18n="payBegin"></span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="timing" value="end" id="payEnd">
          <span data-i18n="payEnd"></span>
        </label>
      </fieldset>

      <div class="grid grid-cols-2 gap-3">
        <label class="block" for="rateYearlyPct">
          <span class="text-sm text-slate-600" data-i18n="yearlyRate"></span>
          <input id="rateYearlyPct" type="number" class="number-input mt-1 w-full rounded-lg border-slate-300 focus:border-primary focus:ring-primary" placeholder="20" step="0.01">
          <span class="text-xs text-slate-500" data-i18n="yearlyHint"></span>
        </label>
        <label class="block" for="durationPreset">
          <span class="text-sm text-slate-600" data-i18n="converter"></span>
          <select id="durationPreset" class="mt-1 w-full rounded-lg border-slate-300 focus:border-primary focus:ring-primary">
            <option value="">—</option>
            <option value="12">1 year (12 months)</option>
            <option value="24">2 years (24 months)</option>
            <option value="36">3 years (36 months)</option>
            <option value="60">5 years (60 months)</option>
          </select>
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-2 pt-2">
        <button id="calcBtn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-sky-600"></button>
        <button id="resetBtn" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50"></button>
        <button id="csvBtn" class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50"></button>
      </div>
    </section>

    <!-- Charts + KPIs -->
    <section class="lg:col-span-2 space-y-6">
      <!-- KPIs -->
      <div class="grid sm:grid-cols-3 gap-3">
        <div class="bg-white rounded-xl p-4 ring-1 ring-slate-200">
          <div class="text-sm text-slate-500" data-i18n="kpiContrib"></div>
          <div id="kpiContrib" class="text-2xl font-semibold">—</div>
        </div>
        <div class="bg-white rounded-xl p-4 ring-1 ring-slate-200">
          <div class="text-sm text-slate-500" data-i18n="kpiTotal"></div>
          <div id="kpiTotal" class="text-2xl font-semibold">—</div>
        </div>
        <div class="bg-white rounded-xl p-4 ring-1 ring-slate-200">
          <div class="text-sm text-slate-500" data-i18n="kpiProfit"></div>
          <div id="kpiProfit" class="text-2xl font-semibold">—</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-white rounded-xl ring-1 ring-slate-200 p-3 sm:p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold" data-i18n="chartTitle"></h3>
          <div class="flex gap-3 text-sm">
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-contrib"></span><span data-i18n="contrib"></span></span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-total"></span><span data-i18n="total"></span></span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-interest"></span><span data-i18n="profit"></span></span>
          </div>
        </div>
        <svg id="chart" class="w-full" height="320" role="img"></svg>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-xl ring-1 ring-slate-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
          <h3 class="font-semibold" data-i18n="tableTitle"></h3>
          <div class="text-sm text-slate-500" data-i18n="tableSubtitle"></div>
        </div>
        <div class="overflow-auto max-h-[420px]">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-slate-600">
                <th class="px-3 py-2 text-right">#</th>
                <th class="px-3 py-2 text-right" data-i18n="deposit"></th>
                <th class="px-3 py-2 text-right" data-i18n="interest"></th>
                <th class="px-3 py-2 text-right" data-i18n="totalContrib"></th>
                <th class="px-3 py-2 text-right" data-i18n="total"></th>
                <th class="px-3 py-2 text-right" data-i18n="profit"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Notes -->
      <div class="text-xs text-slate-500" data-i18n="note"></div>
    </section>
  </main>

  <script>
    // ------------------ Translations ------------------
    const translations = {
      en: {
        title: "SIP Calculator (Monthly Investment)",
        subtitle: "Invest a fixed amount every month, choose monthly return, and see results in graph & table.",
        settings: "Settings",
        amount: "Monthly Investment (₨)",
        monthlyRate: "Monthly Return %",
        months: "Duration (Months)",
        depositTiming: "When is the deposit made?",
        payBegin: "At Beginning of Month (Annuity Due) — Example",
        payEnd: "At End of Month (Ordinary)",
        yearlyRate: "Yearly Return % (Optional)",
        yearlyHint: "If entered, monthly will be auto-calculated",
        converter: "Months/Years Converter",
        calc: "Calculate",
        reset: "Reset",
        csv: "Download CSV",
        kpiContrib: "Total Invested",
        kpiTotal: "Total Value (FV)",
        kpiProfit: "Total Profit / (Loss)",
        chartTitle: "Graph: Total Value vs Contribution",
        contrib: "Contribution",
        total: "Total Value",
        profit: "Profit",
        tableTitle: "Schedule (Monthly)",
        tableSubtitle: "Profit/Loss by month",
        deposit: "Deposit (₨)",
        interest: "Interest This Month (₨)",
        totalContrib: "Total Contributed (₨)",
        note: "Note: This calculator is for educational purposes only. Actual returns may vary due to fees, taxes, and market fluctuations."
      },
      ur: {
        title: "SIP کیلکولیٹر (ماہانہ سرمایہ کاری)",
        subtitle: "ہر مہینے ایک جیسی رقم لگائیں، ماہانہ منافع منتخب کریں، اور گراف و ٹیبل میں نتیجے دیکھیں۔",
        settings: "سیٹنگز",
        amount: "ماہانہ سرمایہ (₨)",
        monthlyRate: "ماہانہ منافع %",
        months: "مدت (مہینے)",
        depositTiming: "رقم کب جمع ہوتی ہے؟",
        payBegin: "مہینے کے شروع میں (Annuity Due) — آپ کی مثال",
        payEnd: "مہینے کے آخر میں (Ordinary)",
        yearlyRate: "سالانہ منافع % (اختیاری)",
        yearlyHint: "ڈالیں تو ماہانہ خود نکالے گا",
        converter: "مہینے/سال کنورٹر",
        calc: "حساب کریں",
        reset: "ری سیٹ",
        csv: "CSV ڈاؤن لوڈ",
        kpiContrib: "کل آپ کی جمع رقم",
        kpiTotal: "کل ویلیو (FV)",
        kpiProfit: "کل منافع / (نقصان)",
        chartTitle: "گراف: ٹوٹل ویلیو بمقابلہ جمع رقم",
        contrib: "جمع رقم",
        total: "کل ویلیو",
        profit: "منافع",
        tableTitle: "شیڈول (ہر مہینہ)",
        tableSubtitle: "منافع/نقصان ہر مہینے کے حساب سے",
        deposit: "جمع (₨)",
        interest: "اس ماہ کا منافع (₨)",
        totalContrib: "جمع شدہ رقم (₨)",
        note: "نوٹ: یہ کیلکولیٹر تعلیمی مقصد کے لیے ہے۔ حقیقی منافع، فیس، ٹیکس اور مارکیٹ کے اتار چڑھاؤ سے مختلف ہو سکتے ہیں۔"
      }
    };

    function applyLanguage(lang) {
      const t = translations[lang] || translations.en;

      document.documentElement.lang = lang;
      document.documentElement.dir = lang === "ur" ? "rtl" : "ltr";
      document.body.style.fontFamily = lang === "ur"
        ? "'Noto Naskh Arabic', system-ui, sans-serif"
        : "system-ui, sans-serif";

      document.querySelector("h1").textContent = t.title;
      document.querySelector("header p").textContent = t.subtitle;
      document.querySelector("section h2").textContent = t.settings;

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (t[key]) el.textContent = t[key];
      });

      document.getElementById("calcBtn").textContent = t.calc;
      document.getElementById("resetBtn").textContent = t.reset;
      document.getElementById("csvBtn").textContent = t.csv;
    }

    // Init language
    const langSelect = document.getElementById("langSelect");
    const savedLang = localStorage.getItem("sip-lang") || "en";
    langSelect.value = savedLang;
    applyLanguage(savedLang);

    langSelect.addEventListener("change", () => {
      const lang = langSelect.value;
      localStorage.setItem("sip-lang", lang);
      applyLanguage(lang);
    });
  </script>


  <script>
    // Helpers
    const fmt = new Intl.NumberFormat('ur-PK', { style: 'currency', currency: 'PKR', maximumFractionDigits: 0 });
    const fmt0 = n => fmt.format(n).replace('PKR', '₨').trim();
    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));

    // Elements
    const el = {
      amount: document.getElementById('amount'),
      rateMonthlyPct: document.getElementById('rateMonthlyPct'),
      rateYearlyPct: document.getElementById('rateYearlyPct'),
      months: document.getElementById('months'),
      durationPreset: document.getElementById('durationPreset'),
      payBegin: document.getElementById('payBegin'),
      payEnd: document.getElementById('payEnd'),
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      csvBtn: document.getElementById('csvBtn'),
      kpiContrib: document.getElementById('kpiContrib'),
      kpiTotal: document.getElementById('kpiTotal'),
      kpiProfit: document.getElementById('kpiProfit'),
      tbody: document.getElementById('tbody'),
      chart: d3.select('#chart')
    };

    // Link yearly<->monthly inputs
    el.rateYearlyPct.addEventListener('input', () => {
      const y = parseFloat(el.rateYearlyPct.value);
      if (!isFinite(y)) return;
      // Convert nominal yearly to effective monthly assuming (1+r_m)^12 = 1+r_y_effective
      const r_m = Math.pow(1 + (y / 100), 1 / 12) - 1;
      el.rateMonthlyPct.value = (r_m * 100).toFixed(3);
    });

    el.durationPreset.addEventListener('change', () => {
      if (el.durationPreset.value) el.months.value = el.durationPreset.value;
    });

    // Core calculation
    function calcSchedule({ P, r, n, payAtBegin = true }) {
      const rows = [];
      let balance = 0;
      let totalContrib = 0;

      for (let m = 1; m <= n; m++) {
        let interest = 0;

        if (payAtBegin) {
          // Annuity Due: deposit, then grow
          balance += P;
          totalContrib += P;
          interest = balance * r;
          balance += interest;
        } else {
          // Ordinary: grow, then deposit
          interest = balance * r;
          balance += interest + P;
          totalContrib += P;
        }

        const profit = balance - totalContrib;
        rows.push({
          month: m,
          deposit: P,
          interest,
          totalContrib,
          balance,
          profit
        });
      }

      // Closed-form FV for cross-check
      const fvOrd = P * ((Math.pow(1 + r, n) - 1) / r);
      const fvDue = fvOrd * (1 + r);
      return { rows, fvOrd, fvDue };
    }

    function run() {
      const P = clamp(parseFloat(el.amount.value || '0'), 0, 1e9);
      const r = clamp(parseFloat(el.rateMonthlyPct.value || '0') / 100, -0.99, 10);
      const n = clamp(parseInt(el.months.value || '0', 10), 1, 600);
      const payAtBegin = el.payBegin.checked;

      const { rows, fvOrd, fvDue } = calcSchedule({ P, r, n, payAtBegin });

      // KPIs
      const totalContrib = P * n;
      const finalValue = payAtBegin ? fvDue : fvOrd;
      const profit = finalValue - totalContrib;

      el.kpiContrib.textContent = fmt0(totalContrib);
      el.kpiTotal.textContent = fmt0(finalValue);
      const profitEl = el.kpiProfit;
      profitEl.textContent = fmt0(profit);
      profitEl.classList.toggle('text-[color:var(--tw-ring-color)]', false);
      profitEl.classList.toggle('text-gain', profit >= 0);
      profitEl.classList.toggle('text-loss', profit < 0);

      // Table
      el.tbody.innerHTML = rows.map(rw => `
        <tr class="odd:bg-white even:bg-slate-50">
          <td class="px-3 py-2 text-right">${rw.month}</td>
          <td class="px-3 py-2 text-right">${fmt0(rw.deposit)}</td>
          <td class="px-3 py-2 text-right">${fmt0(rw.interest)}</td>
          <td class="px-3 py-2 text-right">${fmt0(rw.totalContrib)}</td>
          <td class="px-3 py-2 text-right">${fmt0(rw.balance)}</td>
          <td class="px-3 py-2 text-right ${rw.profit>=0?'text-gain':'text-loss'}">${fmt0(rw.profit)}</td>
        </tr>
      `).join('');

      drawChart(rows, totalContrib);
    }

    // D3 Chart
    function drawChart(rows, totalContrib) {
      const svg = el.chart;
      const width = parseInt(svg.style('width')) || 800;
      const height = parseInt(svg.attr('height')) || 320;
      svg.selectAll('*').remove();

      const margin = { top: 16, right: 20, bottom: 36, left: 56 };
      const w = width - margin.left - margin.right;
      const h = height - margin.top - margin.bottom;

      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
        .domain([1, rows.length])
        .range([0, w]);

      const yMax = d3.max(rows, d => d.balance);
      const y = d3.scaleLinear()
        .domain([0, yMax * 1.05])
        .range([h, 0]);

      const xAxis = d3.axisBottom(x).ticks(Math.min(12, rows.length)).tickFormat(d3.format('d'));
      const yAxis = d3.axisLeft(y).ticks(6).tickFormat(v => fmt0(v));

      // Areas: interest (profit) area
      const areaInterest = d3.area()
        .x(d => x(d.month))
        .y0(d => y(d.totalContrib))
        .y1(d => y(d.balance))
        .curve(d3.curveMonotoneX);

      g.append('path')
        .datum(rows)
        .attr('fill', '#22c55e22')
        .attr('stroke', 'none')
        .attr('d', areaInterest);

      // Lines
      const lineTotal = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.balance))
        .curve(d3.curveMonotoneX);

      const lineContrib = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.totalContrib))
        .curve(d3.curveMonotoneX);

      g.append('path').datum(rows)
        .attr('fill', 'none').attr('stroke', '#0ea5e9').attr('stroke-width', 2.2)
        .attr('d', lineTotal);

      g.append('path').datum(rows)
        .attr('fill', 'none').attr('stroke', '#6366f1').attr('stroke-width', 2.2)
        .attr('d', lineContrib);

      // Axes
      g.append('g').attr('transform', `translate(0,${h})`).call(xAxis);
      g.append('g').call(yAxis);

      // Tooltip
      const tip = g.append('g').style('display', 'none');
      const tipBox = tip.append('rect').attr('fill', 'white').attr('stroke', '#e2e8f0').attr('rx', 6);
      const tipText = tip.append('text').attr('font-size', 12).attr('direction', 'rtl').attr('text-anchor', 'end');

      const overlay = g.append('rect')
        .attr('fill', 'transparent')
        .attr('pointer-events', 'all')
        .attr('x', 0).attr('y', 0).attr('width', w).attr('height', h)
        .on('mousemove', (event) => {
          const [mx] = d3.pointer(event);
          const m = clamp(Math.round(x.invert(mx)), 1, rows.length);
          const d = rows[m - 1];
          tip.style('display', null);
          const lines = [
            `مہینہ: ${d.month}`,
            `جمع شدہ: ${fmt0(d.totalContrib)}`,
            `کل ویلیو: ${fmt0(d.balance)}`,
            `منافع: ${fmt0(d.profit)}`
          ];
          tipText.selectAll('tspan').remove();
          lines.forEach((t, i) => tipText.append('tspan').attr('x', 0).attr('dy', i ? 16 : 0).text(t));
          const bbox = tipText.node().getBBox();
          tipBox.attr('width', bbox.width + 16).attr('height', bbox.height + 12);
          tip.attr('transform', `translate(${x(d.month) + 8}, ${y(d.balance) - (bbox.height + 18)})`);
          tipBox.attr('x', -(bbox.width + 16)).attr('y', -8);
          tipText.attr('x', -12).attr('y', 0);
        })
        .on('mouseleave', () => tip.style('display', 'none'));
    }

    // CSV Download
    function downloadCSV(rows) {
      const header = ['Month','Deposit','InterestThisMonth','TotalContributed','TotalValue','ProfitLoss'];
      const csv = [header.join(',')]
        .concat(rows.map(r => [
          r.month, r.deposit.toFixed(2), r.interest.toFixed(2),
          r.totalContrib.toFixed(2), r.balance.toFixed(2), r.profit.toFixed(2)
        ].join(',')))
        .join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sip_schedule.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Wire buttons
    el.calcBtn.addEventListener('click', run);
    el.resetBtn.addEventListener('click', () => {
      el.amount.value = 2000;
      el.rateMonthlyPct.value = 1.667;
      el.rateYearlyPct.value = '';
      el.months.value = 36;
      el.payBegin.checked = true;
      el.payEnd.checked = false;
      run();
    });
    el.csvBtn.addEventListener('click', () => {
      // Regenerate current rows from inputs and download
      const P = clamp(parseFloat(el.amount.value || '0'), 0, 1e9);
      const r = clamp(parseFloat(el.rateMonthlyPct.value || '0') / 100, -0.99, 10);
      const n = clamp(parseInt(el.months.value || '0', 10), 1, 600);
      const payAtBegin = el.payBegin.checked;
      const { rows } = calcSchedule({ P, r, n, payAtBegin });
      downloadCSV(rows);
    });

    // Initial render
    run();

    // Recalculate on Enter
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') run();
    });

    // Responsive redraw on resize
    window.addEventListener('resize', () => run(), { passive: true });
  </script>
</body>
</html>

